using Revise
using GfPEPS
using LinearAlgebra, ITensors, ITensorMPS
using JSON: parsefile
using ForwardDiff
using Manopt, Manifolds, LinearAlgebra, ManifoldDiff
using Zygote
using Random
using FiniteDifferences, ManifoldDiff, ADTypes
using Printf
import GfPEPS: energy_loss, G_in_Fourier, GaussianMap, Γ_fiducial, ξ, Δ

# load config
configs = parsefile(joinpath(GfPEPS.config_path, "conf_test.json"))

Random.seed!(configs["params"]["seed"])
Nf = configs["params"]["N_physical_fermions_on_site"]
Nv = configs["params"]["N_virtual_fermions_on_bond"]

Lx = configs["system_params"]["Lx"]
Ly = configs["system_params"]["Ly"]
lattice_type = configs["system_params"]["lattice_type"]

# hamiltonian params
t = configs["hamiltonian"]["t"]
Δ_x = configs["hamiltonian"]["Δ_x"]
Δ_y = configs["hamiltonian"]["Δ_y"]
μ = configs["hamiltonian"]["μ"]
δ = configs["hamiltonian"]["hole_density"]

# initial Γ
Tsize = 8*Nv+Nf*2
# Γ = rand(Γsize,Γsize)

T = Float64[
 9.29616093e-01 3.16375555e-01 1.83918812e-01 2.04560279e-01 5.67725029e-01 5.95544703e-01 9.64514520e-01 6.53177097e-01 7.48906638e-01 6.53569871e-01 7.47714809e-01 9.61306736e-01 8.38829794e-03 1.06444377e-01 2.98703714e-01 6.56411183e-01 8.09812553e-01 8.72175914e-01 9.64647597e-01 7.23685347e-01;
 6.42475328e-01 7.17453621e-01 4.67599007e-01 3.25584678e-01 4.39644606e-01 7.29689083e-01 9.94014586e-01 6.76873712e-01 7.90822518e-01 1.70914258e-01 2.68492758e-02 8.00370244e-01 9.03722538e-01 2.46762104e-02 4.91747318e-01 5.26255167e-01 5.96366010e-01 5.19575451e-02 8.95089528e-01 7.28266180e-01;
 8.18350011e-01 5.00222753e-01 8.10189409e-01 9.59685257e-02 2.18950044e-01 2.58719062e-01 4.68105754e-01 4.59373203e-01 7.09509780e-01 1.78053006e-01 5.31449884e-01 1.67742229e-01 7.68813918e-01 9.28170549e-01 6.09493658e-01 1.50183495e-01 4.89626704e-01 3.77344954e-01 8.48601412e-01 9.11097229e-01;
 3.83848721e-01 3.15495903e-01 5.68394153e-01 1.87818035e-01 1.25841544e-01 6.87595805e-01 7.99606718e-01 5.73536565e-01 9.73229982e-01 6.34054377e-01 8.88421725e-01 4.95414759e-01 3.51616530e-01 7.14230369e-01 5.03929116e-01 2.25637607e-01 2.44974440e-01 7.92800700e-01 4.95172415e-01 9.15093673e-01;
 9.45371834e-01 5.33232230e-01 2.52492595e-01 7.20862058e-01 3.67438764e-01 4.98648443e-01 2.26575047e-01 3.53565647e-01 6.50851787e-01 3.12932895e-01 7.68735447e-01 7.81837103e-01 8.52409483e-01 9.49905740e-01 1.07322912e-01 9.10725356e-01 3.36055162e-01 8.26380427e-01 8.98100635e-01 4.27153043e-02;
 1.95794999e-01 2.94501322e-01 6.26999881e-01 8.62231051e-02 1.42945020e-01 5.15826519e-01 6.89341330e-01 8.56625811e-01 6.47361683e-01 5.81618676e-01 7.11115955e-01 2.52416857e-01 9.00159683e-01 4.42293693e-01 2.05208247e-02 9.59661014e-01 6.52225422e-01 5.13206250e-01 6.82356383e-01 4.89540391e-01;
 9.26490171e-01 5.15879772e-01 7.21598817e-02 5.67508298e-01 6.15243184e-01 9.41546294e-01 4.15363355e-01 2.64439975e-01 9.73931654e-02 4.85844222e-01 4.64662863e-01 2.97593170e-02 6.94277462e-01 7.16947112e-01 7.29811423e-01 4.14351017e-01 1.50988448e-02 9.08975157e-01 7.89378718e-01 1.65199169e-01;
 3.12785961e-01 6.10945306e-01 3.64490287e-01 1.56038589e-01 1.77303813e-01 8.67889671e-01 2.90094668e-01 5.85179621e-01 4.53994876e-01 4.11178132e-01 8.82634445e-01 6.92708015e-01 2.79273355e-01 6.44402312e-02 1.98623614e-01 9.31682745e-01 8.54413568e-01 9.54734735e-01 5.22533482e-02 5.79471681e-01;
 4.80496267e-01 2.17089790e-02 3.73620464e-01 4.14091801e-01 6.03907234e-01 6.71748727e-01 8.38865700e-01 7.79526208e-01 4.00701044e-01 7.94529231e-01 8.93124310e-01 2.62489691e-01 9.89197007e-01 8.53307099e-01 7.31477156e-01 3.55565625e-01 8.83289491e-01 8.67959091e-01 9.55766446e-01 1.07256520e-04;
 1.65410419e-02 3.14070057e-01 9.95316175e-01 1.48844223e-01 1.67377119e-01 7.58572037e-01 6.95296662e-02 7.05473439e-01 4.69165282e-01 1.01882161e-02 7.74823863e-01 7.94201008e-01 1.49569452e-01 2.37036318e-02 7.62063771e-01 2.23670180e-01 2.62174398e-01 4.56869503e-01 2.49926919e-01 5.68283562e-01;
 8.46942997e-01 3.78099537e-01 4.32465116e-01 8.32619176e-01 3.71131936e-01 4.05532719e-02 5.54671486e-01 4.51246243e-01 7.25300977e-01 3.78450522e-01 8.40662496e-01 4.69314694e-01 5.62643429e-01 6.61199339e-01 4.62241868e-01 6.23636945e-01 2.21880631e-01 7.32863117e-01 3.81682089e-01 1.94834542e-01;
 2.71162775e-01 2.49225052e-01 1.52139062e-01 7.71373704e-01 2.55411732e-01 1.27543405e-01 6.65167153e-01 4.12804949e-01 6.67767766e-01 6.59813517e-01 3.05377672e-01 2.01224241e-01 2.22027126e-01 1.19970863e-01 3.71454410e-02 3.41315835e-02 2.30496548e-01 2.28353706e-01 6.24910622e-01 8.92561185e-01;
 7.79728016e-01 7.21451269e-01 3.10442159e-01 3.63083416e-01 1.96081784e-01 9.35491798e-01 5.61734000e-01 8.17291537e-01 3.48913981e-01 7.99714263e-01 1.04104463e-01 7.12120165e-01 9.17448496e-01 8.03585369e-01 3.27113146e-01 2.55107179e-01 4.95002174e-01 4.13610954e-01 4.24937095e-01 7.43783048e-02;
 6.03390651e-01 7.47199734e-01 7.97576227e-01 3.81500523e-01 7.97158153e-01 4.71797370e-01 7.21399171e-01 1.89212689e-01 4.34595709e-01 8.23468109e-01 8.26272628e-01 1.89525483e-01 2.01021702e-02 7.03491386e-01 3.47270119e-01 4.19503816e-01 7.68088903e-01 9.62878066e-01 8.92565307e-01 1.34942267e-01;
 7.97804715e-01 6.82090608e-01 5.30052887e-01 8.65981655e-01 7.53248095e-01 9.32025868e-02 3.29439432e-01 4.12362696e-01 9.64607766e-04 5.97563563e-01 6.82561542e-01 3.66280762e-01 3.96498857e-01 4.75359146e-01 5.81079901e-01 1.37137128e-01 9.99414173e-01 5.07327209e-01 4.93066705e-01 1.86874755e-01;
 2.96088015e-01 7.98515059e-01 2.94778293e-01 6.97121593e-01 2.72959229e-01 9.12528451e-01 2.98539234e-01 8.89859772e-01 9.46722294e-01 1.68912823e-01 3.59291406e-01 6.82177303e-01 9.21391970e-01 1.44924344e-01 9.98743850e-02 4.11602777e-01 9.75125371e-01 4.15065409e-02 1.86914295e-01 6.08767988e-01;
 8.72187151e-02 3.16288154e-01 6.10135777e-01 2.01194713e-01 6.91897716e-01 2.44626971e-01 6.80371696e-01 4.85937729e-01 2.60494812e-01 2.82740319e-01 9.05451620e-01 2.75842687e-01 8.41148043e-01 1.96424375e-01 3.30583429e-01 9.46629885e-01 5.06071850e-01 4.03415858e-01 2.70615384e-02 6.21773689e-01;
 3.47348507e-01 2.76799228e-01 6.40547739e-02 3.34390519e-01 6.77099425e-02 3.82424826e-03 4.09678034e-02 3.48954866e-01 9.19543108e-02 5.20315726e-01 2.15749813e-01 9.91666545e-01 2.67187161e-01 6.80168053e-01 5.26246119e-01 4.39923070e-01 6.61555246e-01 1.34785175e-01 7.87849005e-01 1.37977701e-01;
 6.32923298e-01 2.13665358e-01 2.33753147e-02 6.26933973e-01 6.42163727e-01 6.42103337e-01 8.64620900e-01 3.37201403e-01 4.10958387e-01 6.10318684e-01 9.40843191e-01 1.52077270e-01 1.84058006e-01 1.54438288e-01 7.12824326e-01 9.27983161e-01 4.22687180e-01 5.45177264e-01 3.22388965e-01 1.60704683e-01;
 7.03152025e-01 7.30248406e-01 9.60404538e-01 3.70490571e-01 7.16698392e-01 9.86061218e-01 1.10767559e-01 7.58228549e-01 1.57554121e-01 8.16435255e-01 5.54106546e-01 5.81710221e-01 9.36145583e-01 4.34347755e-01 4.89127186e-01 6.66130467e-01 6.30154001e-01 1.30204751e-01 3.53843971e-01 6.35123385e-01
]

# Orthogonalize the initial guess (already done above via SVD; keep as T0)
U,S,V = svd(T)
T = U*V'

if(configs["hamiltonian"]["μ_from_hole_density"])
    μ = solve_mu(Δ_x,δ)
end

E_fct = energy_loss(t, Δ_x, Δ_y, μ, Lx, Ly)
G_in = G_in_Fourier(Lx, Ly, Nv);
CM_out = GaussianMap(Γ_fiducial(T, Nv), G_in, Nf, Nv)
@show E_fct(CM_out)
@time E_fct(CM_out)

# build loss closure
lossT = optimize_loss(t, Δ_x, Δ_y, μ, Lx, Ly, Nf, Nv)

# Manifold
M = Stiefel(Tsize, Tsize)

# cost function is the same, as T is an orthogonal matrix which is in the Stiefel manifold
cost_fct(M,x) = lossT(x)
grad_fct(M,x) = project(M, x, first(Zygote.gradient(lossT, x)))
# grad_fct(M,x) = first(Zygote.gradient(lossT, x))

println("Initial Loss =",cost_fct(M,T))
# display(grad_fct(M,T))
# println(size(grad_fct(M,T)))

# gradient (reverse-mode)
# egrad_zygote(x) = first(Zygote.gradient(lossT, x))
# egrad_zygote(M,x) = egrad_zygote(x)
# gradient (forward-mode)
# egrad_fd(x) = ForwardDiff.gradient(lossT, x)
# X1 = egrad_zygote(T)
# X2 = egrad_fd(T)
# norm(M, T, X1 - X2)

# function grad_f2_AD(M, p)
#     b = Manifolds.RiemannianProjectionBackend(AutoFiniteDifferences(central_fdm(5, 1)))
#     return Manifolds.gradient(M, lossT, p, b)
# end
# X3 = grad_f2_AD(M, T)
# norm(M, T, X1 - X3)


# res = conjugate_gradient_descent(M, cost_fct, grad_fct, T; 
#     coefficient = Manopt.HestenesStiefelCoefficient(M),
#     # stepsize=ArmijoLinesearch(
#     #     M; 
#     #     initial_stepsize=5.0,
#     #     stop_when_stepsize_less=0.1),
#     debug=[:Iteration,
#     (:Cost, " Cost: %1.11f | "), 
#     (:GradientNorm, " Gradient Norm: %1.3e "), "\n",
#     :Stop, 1],
#     stopping_criterion = StopWhenGradientNormLess(1e-7) | StopAfterIteration(150)
# )

using Optim
using ForwardDiff

# very slow...
# g_test(T) = ForwardDiff.gradient(lossT, T)
g(x) = first(Zygote.gradient(lossT, x))
g!(G,x) = copyto!(G, g(x))

@time lossT(T);
@time g(T);

res = Optim.optimize(lossT, g!, T, Optim.ConjugateGradient(manifold=Optim.Stiefel()), Optim.Options(
    iterations = 500,
    g_tol = 1e-7,
    show_trace = true
))

@show Optim.minimum(res)
T_opt = Optim.minimizer(res)